
<muut-demo>

  <header>
    <strong if={ logged }>{ data.user.displayname } &bull;</strong>
    <a if={ !logged } onclick={ login }>Log in</a>
    <a if={ logged } onclick={ logout }>Log out</a>
  </header>

  <!-- post new thread -->
  <form onsubmit={ newThread } if={ logged }>
    <input type="text" name="title" placeholder="What's on your mind?">
    <textarea name="body"/>
    <p>
      <select name="cat">
        <option each={ data.categories } value={ path }>{ title }</option>
      </select>
      <button>Post</button>
    </p>
  </form>

  <!-- thread list -->
  <div class="thread" each={ threads }>
    <img class="avatar" src={ seed.user.img }>

    <main class="seed">
      <h3>{ seed.title }</h3>
      <p each={ para in seed.body }>{ para }</p>
    </main>

    <!-- replies -->
    <div class="reply" each={ replies }>
      <img class="avatar" src={ user.img }>
      <main>
        <p each={ para in body }>{ para }</p>
      </main>
    </div>

    <form onsubmit={ reply } if={ logged }>
      <textarea name="body" placeholder="Reply..."/>
      <p>
        <button>Reply</button>
      </p>
    </form>

  </div>

  <script>
    var data = opts.data,
      api = opts.api,
      self = this

    // context variables
    this.threads = data.moots.entries
    this.logged = data.user.path
    this.data = data


    // opens a new window (see util.js)
    login() {
      openLogin(api.session)
    }

    logout() {
      api.call('logout', { path: api.path }, function() {
        self.update({ logged: false })
      })
    }

    newThread(e) {
      var form = e.target,
        title = form.title.value,
        body = form.body

      // title must be given
      if (!title) return

      // construct seed data
      var seed = {
        key: title.replace(/\W+/, '').toLowerCase(),
        body: body.value.split('\n'),
        path: form.cat.value,
        title: title
      }

      // new thread for rendering
      var thread = { seed: seed, replies: [] }

      // store to IO
      api.call('createThread', seed, function(key) {
        thread.path = seed.path + '#' + key
      })

      // clean form
      form.title.value = ''
      body.value = ''

      // render
      seed.user = data.user
      self.threads.unshift(thread)
      self.update()
    }


    reply(e) {
      var thread = e.item,
        form = e.target

      var body = form.body.value.split('\n'),
        reply = { path: thread.path, body: body }

      api.call('reply', reply, function(key) { reply.key = key })

      reply.user = data.user
      thread.replies.push(reply)
      form.body.value = ''
      self.update()

    }

    /*
      Receive event upon succesfull login.

      Session info is stored in localStorage so the next calls are authenticated.
    */
    api.on('login', function() {

      api.call('init', { path: api.path }, function(json) {
        self.threads = json.moots.entries
        self.data = data = json
        self.logged = true
        self.update()
      })
    })

    function getThread(path) {
      for (var i = 0, thread; (thread = self.threads[i]); i++) {
        if (thread.path == path) return thread
      }
    }

    // new thread event
    api.on('moot', function(thread, seed) {
      thread.seed = seed
      thread.replies = []
      self.threads.unshift(thread)
      self.update()
    })

    // new reply event
    api.on('reply', function(path, reply) {
      var thread = getThread(path)
      if (thread) {
        thread.replies.push(reply)
        self.update()
      }
    })

  </script>

</muut-demo>

